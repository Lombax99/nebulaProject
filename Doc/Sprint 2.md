### Goal
In the previous sprint we saw that using the group feature of nebula allows us to implements all the nebula security domains as needed by requirements.
The solution implemented though, as all the first ideas, is not the best. Knowing that it's possible in this sprint we will reanalyze the project in every aspects and implement a new solution with a different case scenario.

### Problem analysis
##### Single Responsibility principle
In the previous config file we had to define on top of all the hosts and the Security Domains other data like lighthouse and hosts actual and virtual IP (although the actual IP of all the hosts was not necessary in the end... my bad), the reason being that we asked to the script to generate all certificates and key on top of the configuration files that had to then be modified. From a project point of view we asked a singe script to do everything. Let's reanalyze the process and see how to handle it better.
The workflow of the system can be defined with the following points:
1) The Security Domain config file is created
2) Certification and Keys are created for every node of the network
3) Configuration files are created for every host
4) Configuration files are modified to implements Security Domain logic
5) All generated files are distributed to the hosts
By separating the creation of the config file from the modification to implement the firewall rules we could simplify the nebula Security Domain config file.
##### Config file format?
In the first sprint we used JSON as the technology to define the SecDom configuration file but do we have other options?
Of the existing technologies the most common are JSON, YAML (used by nebula itself) and TOML:
- JSON is perhaps the simplest and most intuitive
- YAML seems the most suitable solution being used by nebula itself
- TOML is newer than the previous ones and represents a simpler version of YAML
After some research my choice still falls on JSON for the following reasons:
- YAML is much more complex and error prone than you think (see the [yaml document from hell](https://ruudvanasseldonk.com/2023/01/11/the-yaml-document-from-hell) for reference)
- TOML despite being more secure than YAML is not particularly intuitive
- JSON is intuitive, much less error prone (for now the file has to be generated by hand so this is a big plus) and it is always possible to convert from JSON to YAML, the opposite is not necessarily true.

Regarding the arrangement of the data in the file, two paths can be followed:
1) I write a list of security domains, in each domain I define the list of hosts that belong to it.
	ADVANTAGES:
		- More intuitive for the user when defining the network
		- Easily answers questions such as "who belongs to this SecDom?"
2) I write a list of hosts, in each host I define the list of security domains to which it belongs
	ADVANTAGES:
		- Easier to implement at the code level
		- Easier to answer questions such as "which SecDom does this host belong to?"
Obviously User Friendliness takes precedence over everything else, so the first point is also the best.

NOTE1: As defined above the only data that should appear in the file are the IDs of the Hosts and the SecDoms to which they belong, data such as IPs and special parameters should not be part of it.

NOTE2: Host IDs need not be unique for this project however making them so is not only good practice but would facilitate everything and benefit the end user.

NOTE3: As intuitive as it is JSON, automatically generating the config would remove the problem (at least in part) of a poorly written file, this however would involve having an application to manage the network with GUI and all, that is currently beyond the scope of this project.
([Defined Networking's Managed Nebula](https://www.defined.net/) ðŸ‘€ðŸ‘€)

##### What about the Lighthouse? Can it be part of a security domain?
A lighthouse still needs the same files as any other host; steps 2, 3, and 5 of the workflow are therefore necessary for it as well; the question remains whether a lighthouse can be part of a SecDom or not.
Given the nature of Nebula, every host (except in extremely special cases) must be able to connect at least once to a lighthouse to function properly.

Lighthouses allow Nebula nodes to discover the routable IP addresses of other nodes (i.e. to locate each other.) If the Nebula nodes can't connect to a shared Lighthouse, the only other way they might know where to look is if you define a [static_host_map](https://nebula.defined.net/docs/config/static-host-map/) entry for each other.

It is therefore clear that every host in the network should be able to connect to a lighthouse, for situations where there is only one lighthouse, limiting its connection via SecDom would be a serious mistake. However in Nebula it is possible to implement several lighthouses, in that case it might be possible. 
However, I think it is not a good practice for the simple reason that the main benefit in denying access to a lighthouse would only be useful for the purpose of redistributing the workload in the network but to do that nebula defines better tools through the config file, so it is not the job of SecDom to take care of that.
Little extra: nebula communicates with peer-to-peer encrypting, it is not possible to sniff the traffic passing through the lighthouse, also in case of an attack one could consider blocking certain hosts from communicating with the lighthouse but it is not the task of this project to handle such a case.

Final answer then is no, but practically speaking i can't block a user from putting a node called "lighthouse" in the config, maybe i should at least print some warning telling them it's not a good practice
##### What about scalability?
As the number of nodes increases, the complexity in the JSON file increases linearly as does the file creation time.
##### How to auto generate?
Using a linux script has several limitations:
- It is not easily portable to other platforms and/or architectures (if not impossible)
- it exploits "jq" a tool not necessarily present, in order to ensure execution it would require automatic installation and consequently sudo permission --> bad
- is monolithic
For the new version we will use a programming language that is distributable on different platforms and organized as much as possible in components.
My choice falls on Python for ease of use and familiarity.
##### Deployment of the files?
Each node in the network must have:
- a personal certificate key pair
- the CA's certificate (but not the key)
- the config file
- the nebula executable (or nebula installed)
Needs to deploy on linux, Freebsd, windows, macOS, iOS, android.
These issues are beyond the scope of this project and will not be addressed. 
([Defined Networking's Managed Nebula](https://www.defined.net/) ðŸ‘€ðŸ‘€)

### Test
[[Vagrant/vagrant_esempio2_nebula/Vagrantfile|Vagrantfile]]
In this second case we will have 6 machines including 3 laptops in one SecDom, 2 servers in a different SecDom, and the lighthouse. Two of the three laptops must be able to connect with only one of the servers.
We are simulating a distributed server in a cluster of machines with one of them acting as a gate for some of the laptops.

### Design
In this case we need 3 security domains, one for the laptops, one for the servers and one for connecting to the server.
The configuration file ([[securityDomains.json]]) is defined as follows:
```JSON
[
    {
        "name": "serverSD",
        "hosts": ["server1", "server2"]
    },

    {
        "name": "serverAccessSD",
        "hosts": ["server1", "laptop1", "laptop2"]
    },

    {
        "name": "laptopSD",
        "hosts": ["laptop1", "laptop2", "laptop3"]
    }
]
```




NOTA4: A questo punto mi ritrovo con due file di config, uno con i dati con gli ip e uno con i security domains, lascio che a livello di codice si gestiscano i conflitti e si assicuri che siano ben formati ma questo porta a nuovi possibili problemi, gli id devono essere corretti nei due file e devono essere definiti tutti, in compenso ho modo di fare merge dei dati delle SecDom in entrambi i file e avere entrambe le opzioni definite sopra per visualizzare la struttura della mia rete. La soluzione perfetta sarebbe abbandonare completamente la generazione manuale di questi file e passare ad un tool software per definire l'intera rete e nascondere i formati dei file salvati allÃ¬utente finale permettendogli di accedere e modificare le informazioni legate alla struttura della rete attraverso il tool.

### PROBLEM CASE: Mistrustful Colleagues
This new solution is a great advancement compared to the first shell script we had but it's not perfect, in this specific case for example what happens when we decide to have all the laptop able to connect to the server but not to each other? As of right now each and every laptop would need a specific Security Domain with the server.
In the next sprint we will face this problem and search for a possible solution.